version: 2
jobs:
  build:
    docker:
      # The first image listed is the image that all steps run inside of.
      # This can be modified by steps, or can be built as a separate
      # customized container.
      - image: circleci/ruby
        environment:
          - dev: enrique
          - DBUS_SESSION_BUS_ADDRESS: /dev/null
          - RAILS_ENV: test
          - NODE_ENV: test
          - MOCHA_FILE: /home/circleci/test-results/mocha/mocha.xml
          - BUNDLE_PATH: vendor/bundle
          - KARMA_JUNIT_OUTPUT_DIR: /home/circleci/karma-test-results/karma
          - KARMA_JUNIT_OUTPUT_FILE: /home/circleci/karma-test-results/karma/karma.xml
          - COVERAGE_DIR: /home/circleci/coverage
          - POSTGRES_HOST: localhost
          - POSTGRES_USER: root
      # This is the circleci provided Postgres container. We can
      # configure it via environment variables.
      - image: circleci/postgres:10.2
        environment:
          - POSTGRES_USER: root
            POSTGRES_DB: caseflow_certification_test

      # This is our homespun VACOLS container. An oracle db with some special sauce.
      #- image: 008577686731.dkr.ecr.us-gov-west-1.amazonaws.com/facols:version_2

      # This is the circleci provided Redis container.
      #- image: circleci/redis:4.0.10
    #parallelism: 5
    resource_class: large
    steps:
        - checkout

        - run:
            name: Install dependencies
            command: sudo apt-get install pdftk libaio1 libaio-dev
        
        - run:
            name: Install Oracle Client
            command: |
                unzip /home/circleci/project/oracle_libs/*.zip
                pwd
                ls -lsa
                cd /home/circleci/project/oracle_libs/instantclient_12_1/
                ln -s libclntsh.so.12.1 libclntsh.so

        - run:
            name: Print working directory
            command: |
                pwd
                ls -lsa
                echo $LD_LIBRARY_PATH
        
        - run:
            name: Print env variables
            command: env


        - run:
            name: Setup testfiles directory
            command: ~/project/ci-bin/capture-log "mkdir -p ~/project/tmp/testfiles"

        - run:
            name: Ruby version
            command: ruby -v

        - restore_cache:
            keys:
                - vendor-bundle-v1-{{ arch }}-{{ checksum ".ruby-version" }}-{{ checksum "Gemfile.lock" }}

        - run:
            name: Print Oracle env variable
            command: |
                export LD_LIBRARY_PATH=/home/circleci/project/oracle_libs/instantclient_12_1/
                echo 'export LD_LIBRARY_PATH="/home/circleci/project/oracle_libs/instantclient_12_1/:$LD_LIBRARY_PATH"' >> $BASH_ENV
                env

        - run:
            name: Bundle install
            command: sudo env LD_LIBRARY_PATH=$LD_LIBRARY_PATH bundle install --path vendor/bundle
