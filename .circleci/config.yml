# circle ci version
version: 2.1

browser_tools_versions: &browser_versions
  chrome-version: 106.0.5249.119
  firefox-version: 106.0.1

# A command defines a sequence of steps as a map to be executed in a job, enabling you to reuse a single command definition across multiple jobs.
# 4 total commands
commands:
  install_ruby_dependencies: #Command Name
    description: "Install Ruby Dependencies" 
    steps: #The sequence of operations run over the course of the Command
      - run:
          name: Ruby version #Displayed in the CircleCI interface. Can be expanded to show details
          command: ruby -v

      - run:
          name: Configure Bundler
          command: |
            echo 'export BUNDLER_VERSION=$(cat Gemfile.lock | tail -1 | tr -d " ")' >> $BASH_ENV
            source $BASH_ENV
            gem install bundler

      - restore_cache: 
          keys: # The unique identifier for the cache. Arch is the cpu and os being run. 
            - vendor-bundle-v2-{{ arch }}-{{ checksum ".ruby-version" }}-{{ checksum "Gemfile.lock" }}

      - run:
          name: Bundle install
          command: bundle install --path vendor/bundle

      - save_cache:
          key: vendor-bundle-v2-{{ arch }}-{{ checksum ".ruby-version" }}-{{ checksum "Gemfile.lock" }}
          paths: #The paths: tag directly relates to the file(s) being affected
            - ~/project/vendor/bundle

  install_node_dependencies:
    description: "Install NodeJS Dependencies"
    steps:
      - restore_cache:
          name: Restore yarn cache
          key: dot-cache-yarn-v2-{{ arch }}-{{ checksum "client/yarn.lock" }}

      - run:
          name: yarn install
          command: ~/project/ci-bin/capture-log "cd client && yarn install --frozen-lockfile"

      - save_cache:
          key: dot-cache-yarn-v2-{{ arch }}-{{ checksum "client/yarn.lock" }}
          paths:
            - ~/.cache/yarn
            - public/assets
            - tmp/cache/assets/sprockets

  install_dockerize:
    description: "Install Dockerize"
    steps:
      - run:
          name: install dockerize
          command: wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && sudo tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
          environment:
            DOCKERIZE_VERSION: v0.6.1

  wait_for_databases:
    description: "Wait for FACOLS and PostgreSQL"
    steps:
      - run:
          name: Wait for database
          command: dockerize -wait tcp://localhost:5432 -timeout 1m

      # see config/environments/test.rb:65
      - run:
          name: Wait for FACOLS to be ready
          command: |
            ~/project/ci-bin/capture-log "bundle exec rake local:vacols:wait_for_connection"
          environment:
            DISABLE_FACTORY_BOT_INITIALIZERS: 1

# CircleCI orbs are shareable packages of configuration elements, including jobs, commands, and executors. Orbs make writing and customizing CircleCI config simple.
# The reusable configuration elements used in orbs are explained fully in the Reusable Configuration Reference.


# https://docs.github.com/en/actions/migrating-to-github-actions/migrating-from-circleci-to-github-actions#migrating-orbs-to-actions
# called 'actions' in GH actions
orbs:
  browser-tools: circleci/browser-tools@1.4.0

# A Workflow is comprised of one or more uniquely named jobs. Jobs are specified in the jobs map, see Sample config.yml for two examples of a job map.
# The name of the job is the key in the map, and the value is a map describing the job.
jobs:
  # build workspace
  build_workspace:
    docker:
      # The first image listed is the image that all steps run inside of.
      # This can be modified by steps, or can be built as a separate
      # customized container.
      - image: cimg/node:12.3.0 # NodeJS Version defined in ./nvmrc
        environment:
          - DBUS_SESSION_BUS_ADDRESS: /dev/null
          - RAILS_ENV: test
          - NODE_ENV: test
    resource_class: large
    steps:
      - checkout #Aquires the code necessary for the tests
      - install_node_dependencies #A call to the command we made ealrier 

      - run:
          name: Build webpack
          command: ~/project/ci-bin/capture-log "cd client && yarn build:test"

      # creates a temporary file for other jobs to use later on
      # check GHA to see if there's anything similar
      - persist_to_workspace:
          root: .
          paths:
            - .

  # validate our demo/development setup
  demo:
    docker:
      # The first image listed is the image that all steps run inside of.
      # This can be modified by steps, or can be built as a separate
      # customized container.
      - image: 008577686731.dkr.ecr.us-gov-west-1.amazonaws.com/cimg-ruby:2.7.3-browsers
        environment:
          - DBUS_SESSION_BUS_ADDRESS: /dev/null
          - RAILS_ENV: test
          - NODE_ENV: test
          - BUNDLE_PATH: vendor/bundle
          - COVERAGE_DIR: /home/circleci/coverage
          - POSTGRES_HOST: localhost
          - POSTGRES_USER: root
      # This is the circleci provided Postgres container. We can
      # configure it via environment variables.

      # need to change to GHA/non circleCI container
      - image: circleci/postgres:11.7
        environment:
          - POSTGRES_USER: root
            POSTGRES_PASSWORD: password
            POSTGRES_DB: caseflow_certification_test

      # This is our homespun VACOLS container. An oracle db with some special sauce.
      - image: 008577686731.dkr.ecr.us-gov-west-1.amazonaws.com/facols:latest

      # This is the circleci provided Redis container.
      # need to change to GHA/non circleCI container
      - image: circleci/redis:4.0.10
    resource_class: large #Specifies the amount of ram and number of cpu's used
    steps:
      - checkout

      - run:
          name: Setup testfiles directory
          command: ~/project/ci-bin/capture-log "mkdir -p ~/project/tmp/testfiles"

      - install_node_dependencies

      - install_ruby_dependencies

      - install_dockerize

      - wait_for_databases

      - run:
          name: Database setup
          command: |
            ~/project/ci-bin/capture-log "DB=etl bundle exec rake db:create db:schema:load db:migrate"
            ~/project/ci-bin/capture-log "bundle exec rake db:create db:schema:load db:migrate"

      - run:
          name: make seed-dbs
          command: |
            ~/project/ci-bin/capture-log "make -f Makefile.example seed-dbs"

      - run:
          name: Assets Precompile
          command: |
            ~/project/ci-bin/capture-log "bundle exec rake assets:precompile"

      - store_artifacts:
          name: Store test results as artifact
          path: ~/test-results

      - store_artifacts:
          name: Store run logs
          path: ~/logs

  rspec:
    docker:
      # The first image listed is the image that all steps run inside of.
      # This can be modified by steps, or can be built as a separate
      # customized container.
      - image: 008577686731.dkr.ecr.us-gov-west-1.amazonaws.com/cimg-ruby:2.7.3-browsers
        environment:
          - DBUS_SESSION_BUS_ADDRESS: /dev/null
          - RAILS_ENV: test
          - NODE_ENV: test
          - BUNDLE_PATH: vendor/bundle
          - COVERAGE_DIR: /home/circleci/coverage
          - POSTGRES_HOST: localhost
          - POSTGRES_USER: root
      # This is the circleci provided Postgres container. We can
      # configure it via environment variables.
      - image: circleci/postgres:11.7
        environment:
          - POSTGRES_USER: root
            POSTGRES_PASSWORD: password
            POSTGRES_DB: caseflow_certification_test

      # This is our homespun VACOLS container. An oracle db with some special sauce.
      - image: 008577686731.dkr.ecr.us-gov-west-1.amazonaws.com/facols:latest

      # This is the circleci provided Redis container.
      - image: circleci/redis:4.0.10
    parallelism: 12
    resource_class: large
    steps:
      - attach_workspace:
          at: .

      - run:
          name: Setup testfiles directory
          command: ~/project/ci-bin/capture-log "mkdir -p ~/project/tmp/testfiles"

      - browser-tools/install-browser-tools:
          <<: *browser_versions

      - install_ruby_dependencies

      - install_dockerize

      - wait_for_databases

      - run:
          name: Database setup
          command: |
            ~/project/ci-bin/capture-log "DB=etl bundle exec rake db:create db:schema:load db:migrate:redo"
            ~/project/ci-bin/capture-log "bundle exec rake db:create db:schema:load db:migrate:redo"

      - run:
          name: FACOLS test setup
          command: |
            ~/project/ci-bin/capture-log "bundle exec rake spec:setup_vacols"

      - run:
          # https://docs.knapsackpro.com/2019/how-to-run-rspec-on-github-actions-for-ruby-on-rails-app-using-parallel-jobs
          name: RSpec via knapsack_pro Queue Mode
          command: |
            mkdir -p ~/test-results/rspec
            export RAILS_ENV=test
            bundle exec rake "knapsack_pro:queue:rspec[--format documentation --no-color --format RspecJunitFormatter --out tmp/rspec.xml]"
          environment:
            KNAPSACK_PRO_RSPEC_SPLIT_BY_TEST_EXAMPLES: true
            # Uncomment to profile test performance in CircleCI
            #  RDOC: 1
            #  RD_PROF: 1
            #  FPROF: 1

      - store_test_results:
          name: Store test results as summary
          path: ~/test-results

      - store_artifacts:
          name: Store test results as artifact
          path: ~/test-results

      - store_artifacts:
          name: Store code coverage
          path: ~/coverage

      - store_artifacts:
          name: Store capybara screenshots
          path: ~/project/tmp/capybara

      - store_artifacts:
          name: Store rails test log
          path: ~/project/log/test.log

      - store_artifacts:
          name: Store bullet log
          path: ~/project/log/bullet.log

      - store_artifacts:
          name: Store run logs
          path: ~/logs

      - deploy:
          name: Verify code coverage
          command: |
            ~/project/ci-bin/capture-log "bundle exec rake ci:circleci_verify_code_coverage"

      - deploy:
          name: Concatenate all logs
          command: |
            ~/project/ci-bin/concatenate-log.rb >> ~/all_logs.log
          when: always

      - store_artifacts:
          name: Store concatenated logs
          path: ~/all_logs.log

      - store_artifacts:
          name: Store final coverage
          path: ~/coverage/combined

  lint:
    docker:
      # The first image listed is the image that all steps run inside of.
      # This can be modified by steps, or can be built as a separate
      # customized container.
      - image: 008577686731.dkr.ecr.us-gov-west-1.amazonaws.com/cimg-ruby:2.7.3-browsers
        environment:
          - DBUS_SESSION_BUS_ADDRESS: /dev/null
    steps:
      - checkout

      - install_ruby_dependencies

      - install_node_dependencies

      - run:
          name: Danger
          command: |
            ~/project/ci-bin/capture-log "bundle exec danger"

      - run:
          name: Lint
          command: |
            ~/project/ci-bin/capture-log "bundle exec rake lint"

      - run:
          name: Security
          command: |
            ~/project/ci-bin/capture-log "bundle exec rake security"

      - deploy:
          name: Concatenate all logs
          command: |
            ~/project/ci-bin/concatenate-log.rb >> ~/all_logs.log
          when: always

      - store_artifacts:
          name: Store concatenated logs
          path: ~/all_logs.log

  js_tests:
    docker:
      # The first image listed is the image that all steps run inside of.
      # This can be modified by steps, or can be built as a separate
      # customized container.
      - image: cimg/ruby:2.7.3-browsers # NodeJS Version defined in ./nvmrc
        environment:
          - DBUS_SESSION_BUS_ADDRESS: /dev/null
          - NODE_ENV: test
          - JEST_DIR: /home/circleci/test-results/jest
          - TEST_REPORTER: jest-junit
          - JEST_JUNIT_OUTPUT_DIR: /home/circleci/test-results/jest
          - COVERAGE_DIR: /home/circleci/coverage
    resource_class: large
    steps:
      - browser-tools/install-browser-tools:
          <<: *browser_versions
      - checkout
      - run:
          # we will still need python going forward as a node-gyp@3.8.0 dependency
          # node-gyp is a cross-platform command-line tool written in Node.js for compiling native addon modules for Node.js.
          # It bundles the gyp project used by the Chromium team and takes away the pain of dealing with the various differences in build platforms.
          name: Install python-2 as a node-gyp@3.8.0 dependency
          command: |
            sudo apt-get update
            sudo apt-get install -y python2

      - install_node_dependencies

      - run:
          name: Jest
          command: |
            mkdir -p ~/test-results/jest
            pushd client
            ~/project/ci-bin/capture-log "node_modules/.bin/jest --ci --reporters=default --reporters=jest-junit --maxWorkers=4"

      - store_test_results:
          name: Store test results as summary
          path: ~/test-results

      - store_artifacts:
          name: Store test results as artifact
          path: ~/test-results

      - deploy:
          name: Concatenate all logs
          command: |
            ~/project/ci-bin/concatenate-log.rb >> ~/all_logs.log
          when: always

      - store_artifacts:
          name: Store concatenated logs
          path: ~/all_logs.log
# Used for orchestrating all jobs. Each workflow consists of the workflow name as a key and a map as a value. A name should be unique within the current config.yml.
workflows:
  version: 2
  build:
    jobs:
      - build_workspace:
          filters:
            branches:
              ignore:
                - gh-pages
                - main-gh-pages
                - gh-actions/make_docs-update_docs
      - demo:
          filters:
            branches:
              ignore:
                - gh-pages
                - main-gh-pages
                - gh-actions/make_docs-update_docs
      - rspec:
          requires:
            - build_workspace
          filters:
            branches:
              ignore:
                - gh-pages
                - main-gh-pages
                - gh-actions/make_docs-update_docs
      - js_tests:
          filters:
            branches:
              ignore:
                - gh-pages
                - main-gh-pages
                - gh-actions/make_docs-update_docs
      - lint:
          filters:
            branches:
              ignore:
                - gh-pages
                - main-gh-pages
                - gh-actions/make_docs-update_docs
