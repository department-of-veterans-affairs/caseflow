# Hearing Day Distribution Algorithm

## Background

The new distribution algorithm created for [CASEFLOW-409](https://vajira.max.gov/browse/CASEFLOW-409) results in a normal distribution of hearing days across valid dates in the specified range. For example, when we tested with the same inputs used to build the Q3 FY21 hearing schedule it created a schedule with an average of 32 hearing days / date and a standard deviation of +/- 6 days.

The problem is that two standard deviations above the average would create 40+ hearing days on several dates and the Branch doesn't have enough VLJs or coordinators to run that many hearing days on a given date. The standard deviation needs to be more like 1 or 2 hearing days, so in the example above it would create more like 30-34 hearing days per date.

This was previously enforced by using the number of rooms at 425 I (and later however many "fake" rooms we added to Caseflow) as an upper limit.

## Overview

The hearing day assignments algorithm attempts to create an evenly distributed number of hearing days across a date range given the following:

1. List of Regional Office blackout dates
2. List of Regional Office hearing days requested
3. List of Board blackout dates

The blackout dates are removed from the list of available dates along with any holidays and weekends that fall within the date range to generate a list of availability dates for each Regional Office. There are 3 types of hearing day distributions that are generated by the assignments algorithm:

- Hearing Days with rooms
- Hearing Days with NO rooms (Virtual)
- Central Office Hearing Days

The only variation that will be changed will be the second distribution for the hearing days without rooms. The initialization is the same for all 3 types which will not be changed by this modification as all 3 variations need to account for the blackout dates and holidays/weekends.

### Initialization Process

- First we generate a list of availability dates for each individual Regional Office by creating a new instance of the `HearingSchedule::GenerateHearingDaysSchedule` class which does the following:
  - Extract all the dates that the regional offices are not available [blackout dates](https://github.com/department-of-veterans-affairs/caseflow/blob/ed0a3fcf3f565167329be37d7652046f5465ccbd/app/services/hearing_schedule/generate_hearing_days_schedule.rb#L46)
  -  Remove the holidays within the date range using the date/holiday ruby gem
  -  Loop through the days in the range and pull out only the business days, removing weekends and holidays to generate the available days within the date range (see [filter non-availability dates](https://github.com/department-of-veterans-affairs/caseflow/blob/ed0a3fcf3f565167329be37d7652046f5465ccbd/app/services/hearing_schedule/generate_hearing_days_schedule.rb#L80))
  -  Generate a new hash containing the Regional Office key corresponding to the requested hearing days with rooms and without rooms as well as the number of rooms and overall available days for the date range
  -  Loop each Regional Office in the new hash and decrement the available days for each date listed as a blackout date for the Regional Office
  -  Repeat the previous step for any travel board hearing days received from VACOLS
- Next we run the distribution algorithm for each of the 3 types above applying the constraints we just created in the initialization

### Current Process

**NOTE:** This only covers the `with_rooms` path of this algorithm

- Sort the regional office by the "most booked" which is determined by the highest ratio of requested days to rooms and availability dates within the range
- For each Regional Office, group the availability dates by month
- Extract the number of days requested per month by taking the requested days per Regional Office and spreading them across the date range
    - This is completed using a [weighted distribution algorithm](https://github.com/department-of-veterans-affairs/caseflow/blob/ed0a3fcf3f565167329be37d7652046f5465ccbd/app/services/hearing_schedule/ro_distribution.rb#L20)
- Loop through the monthly requested days per Regional Office and add a hearing day to the list for that Regional Office and date
    - Skip if there are no available days or no requested days
    - Generate a date offset so we don't bunch days all at the beginning of the month by doing the following:
        - Get the remainder of the requested days / count of available days for this month
        - If the requested days is less than the count of available days this month, use the requested days as the offset divisor. Else use the remainder calculated above
        - Set the offset to 0 if the remainder is 0, otherwise calculate the offset by dividing the count of available days by the offset divisor determined in the previous step
    - Define an initial number of days to assign to each date this month for this Regional Office (starts at 1)
    - Define an initial offset index to 0 so we start with the first available day when trying to add new hearing days to the list for this Regional Office
    - Loop through the requested days and try to add a new day to the list of days for that Regional Office by doing the following:
        - Check whether the available days for this regional office all have exactly the number of days to allocate for this regional office
            - If true add 1 to the number to allocate
            - If false continue without increasing the number to allocate
        - Calculate a new offset index within the available days by checking whether a day has already been added for the date at the initial offset index
            - If true we get the next date in the list of available days skipping around the available days array by the offset amount calculated above
            - If false we use the current date
        - Add the new date located in the previous step to the list of hearing days for this Regional Office
- The last step actually creates the hearing day instances by looping through each Regional Office in the list generated in the previous step and creating a HearingDay object for each date added in the previous step

### Suggested Process

**NOTE:** The proposed process would change where the split between the `with_rooms` and `without_rooms` variations occurs from [this line](https://github.com/department-of-veterans-affairs/caseflow/blob/ed0a3fcf3f565167329be37d7652046f5465ccbd/app/services/hearing_schedule/generate_hearing_days_schedule.rb#L222) to [this one](https://github.com/department-of-veterans-affairs/caseflow/blob/ed0a3fcf3f565167329be37d7652046f5465ccbd/app/services/hearing_schedule/generate_hearing_days_schedule.rb#L181). This is because we are now trying to distribute evenly across the date range instead of across months per Regional Office

- Sort the Regional Office list by the total requested days least to most
- Sum the total requested days for all Regional Offices across the date range
- Sum the total availability dates across all Regional Offices
- Divide the total requested days by the total availability dates to calculate the average number of hearing days per date
- Take the remainder of the requested days divided by the total availability dates to calculate the date offset to be used after each availability date has the calculated number of hearing days per date
- Define the initial date index to be 0 so we start with the first available date
- For each hearing day that needs to be scheduled find the next available date and Regional Office available for that date
    - Starting at the initial index get a Regional Office from the sorted list that is available for the date at that index in the available hearing dates list
    - Decrement the number of requested days (allocations) for the selected Regional Office by 1 and move them to the bottom of the list, when a regional office has no more requested days remove them from the list
    - Add a hearing day for the selected date and move to the next iteration of inner loop
    - Repeat the previous steps until the remaining hearing days to schedule across all ROs is equal to the difference between the total hearing days to schedule and the total availability dates (requested - available), then start applying the offset to the index we use to find the next available date so that we do not bunch hearing days together
        - If the next index is on a date that is blacked out for all remaining Regional Offices, increase the index by 1
        - If the next index is on a date that already has the number of hearing days, then increase the index by 1
        - If the next index in the hearing days list is out of bounds, circle back around to the beginning of the array and continue. Example:
            - Array Length: 4
            - Current Index: 3 (last element)
            - Next Index: 1
            - Resulting Index: 0 (loops back to the beginning of the array)
- Create the HearingDay objects for each date in the list that was generated from the previous step

## Goals

The outcome of the modified algorithm should be that there is an evenly distributed number of hearing days without rooms per date across all Regional Offices from the allocations spreadsheet. This means that for a given month there should be no more than 1 - 2 days difference between the count of hearing days created for any single date in that month across all Regional Offices.

Additionally we should separate the `with_rooms` and `without_rooms` variations into separate functions

**Example A**

Given the following:

- 1 month period
- 20 dates available in the month for all Regional Offices
- 1 Regional Office with 40 requested hearing days and no blackout dates
- All other 54 Regional Offices, a single day requested and no blackout dates

Then we need to generate 94 (54 * 1 + 40) hearing days

- Each date will get 4 (94 / 20) hearing days
- Every other 14 (94 % 20) dates within the availability range will get additional 1 day making a total of 5 days

**Example B**

Given the following:

- 1 month period
- 20 dates available in the month for all Regional Offices
- 1 Regional Office with 40 requested hearing days and 5 blackout dates (15 days available)
- All other 54 Regional Offices, a single day requested and no blackout dates

Then we need to generate 94 (54 * 1 + 40) hearing days

- Each date will get 4 - 5  (94/20 and 1 additional for the dates that were offset) hearing days
- Every other 14 (94 % 20) dates within the availability range will get 4 - 5 hearing days unless that date is one of the blackout dates for the RO requesting 40 days in which case it will be every other 14 plus x days where x is the index offset by the blackout days for the RO

**Example C**

Given the following:

- 1 month period
- 20 dates available in the month for all Regional Offices
- 2 Regional Offices with 40 requested hearing days and 5 blackout dates (15 days available each)
- All other 53 Regional Offices, a single day requested and no blackout dates

Then we need to generate 134 (53 * 1 + 40 * 2) hearing days

- Each date will get 6 - 7 (134/20 and 1 additional for the dates that were offset) hearing days
- Every other 14 (134 % 20) dates will get 6 - 7 hearing days unless that date is one of the blackout dates for either of the ROs requesting 40 days in which case it will be every other 14 plus x days where x is the index offset by the blackout days for that RO

## Risks

- Because we are only changing 1 variation of the algorithm there is a risk of effecting the other variations, but this should be able to be mitigated with the RSpec tests
- Historically we have under-estimated the work on this algorithm so there is some risk in implementation taking a bit longer than expected
