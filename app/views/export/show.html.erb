<% content_for :head do %>
<%= stylesheet_link_tag 'export_appeal' %>
<% end %>

<div style="font-size:0.875em; padding:10px">
  <details>
    <summary style="color: blue">Help</summary>
    URL query parameter options:
    <ul>
      <li><code><%= link_to('show_pii', {action: 'show', show_pii: ""}) %></code>: shows PII in the Intake section</li>
      <li><code><%= link_to('fields=id,status,updated_at', {action: 'show', fields: "id,status,updated_at"}) %></code>: custom fields to show in the Task tree section</li>
    </ul>
    <div id="treeefields" style="width: 200px; height: 300px; overflow-y: scroll; padding:10px">
      <% available_fields.each do |field_name| %>
        <% if treee_fields.include?(field_name.to_sym) %>
          <input type="checkbox" name="<%=field_name%>" id="<%=field_name%>" checked />
        <% else %>
          <input type="checkbox" name="<%=field_name%>" id="<%=field_name%>" />
        <% end %>
        <label for="<%=field_name%>"><%=field_name%></label>
      <% end %>
    </div>
    <p/><a id="task_tree_link" href="">Update task tree</a>

    <p/>Other formats:
    <%= link_to('text', {action: 'show', format: "text"}) %>, 
    <%= link_to('json', {action: 'show', format: "json"}) %>
    <hr/>
  </details>

  <h2>Basic Info about this Appeal</h2>
  <ul>
    <li>status: <%= appeal_status.to_s %></li>
    <li>priority? AOD: <%= appeal.aod? %>, CAVC: <%= appeal.cavc? %></li>
  </ul>

  <h3>Task tree</h3>
  <code style="color: green">
    Appeal.find(<%= appeal.id %>).treee(<%= treee_fields.map{|f| f.to_s.prepend(":")}.join(", ") %>)
    <% if appeal.is_a?(LegacyAppeal) %>
      <br/>la = LegacyWorkQueue.tasks_by_appeal_id(<%= appeal.vacols_id %>)
      <br/>la.location_history.map(&:summary)
    <% end %>
  </code>
  <pre style="font-size:0.84em; padding:10px"><code><%= task_tree_as_text %></code></pre>
  <hr/>

  <h3>Intake</h3>
  <code style="color: green">
    puts IntakeRenderer.render(Appeal.find(<%= appeal.id %>), 
      show_pii: <%= show_pii_query_param ? "true" : "false" %>)
  </code>
  <pre style="font-size:0.84em; padding:10px"><code><%= intake_as_text %></code></pre>
  <hr/>

  <%= javascript_include_tag 'export-appeal' %>
  <script type="text/javascript">
    // Handle Task Tree field checkboxes
    function updateTaskTreeLink(){
      var selected = $('#treeefields input:checked').map( (idx, elem) => elem.name ).get();
      $('#task_tree_link').attr("href", window.location.href.split('?')[0]+"?fields="+selected.join(','));
    }
    updateTaskTreeLink();
    $('#treeefields input').change( () => updateTaskTreeLink() );
  </script>

  <% unless legacy_appeal? %>
    <h2>Related Appeals and Associated Records</h2>
    <p>The following subsections are created from the <b><%= show_pii_query_param ? "unsanitized" : "sanitized" %></b>
      <%= link_to('json export', {action: 'show', format: "json"}) %>, which are composed of these appeals:
      <ul>
        <% sje.records_hash["appeals"].each do |appeal| %>
          <li>Appeal id: <%= appeal["id"] %>, uuid: <%= appeal["uuid"] %></li>
        <% end %>
      </ul>
    </p>

    <h3>Timeline</h3>
    <div id="timeline"></div>
    <hr/>

    <h3>Network graph</h3>
    <details>
      <summary style="color: blue">Filter nodes</summary>
      <div id="nodeFilters" style="width: 200px; height: 300px; overflow-y: scroll; padding:10px">
        <% ["tasks", "users", "organizations"].each do |tableName| %>
          <input type="checkbox" name="<%=tableName%>" id="<%=tableName%>" value="<%=tableName%>" checked />
          <label for="<%=tableName%>"><%=tableName%></label>
        <% end %>
      </div>
    </details>
    <div id="netgraph"></div>
    <details>
      <summary style="color: blue">Network graph data</summary>
      <pre style="font-size:0.75em; padding:10px"><code><%= JSON.pretty_generate(network_graph_data) %></code></pre>
    </details>
    <hr/>

    <script type="text/javascript">
      // Network graph
      var network_graph_data = <%= network_graph_data.to_json.html_safe %>;
      addNetworkGraph("netgraph", network_graph_data);
  
      // Timeline
      var timeline_data = <%= timeline_data.to_json.html_safe %>;
      addTimeline('timeline', timeline_data);
    </script>
  <% end %>
</div>
